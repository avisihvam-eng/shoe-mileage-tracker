<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0c0c0d">
<title>Shoe Mileage</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0c0d;
  --surface: #161618;
  --surface2: #1e1e21;
  --surface3: #262629;
  --border: #2a2a2e;
  --border2: #333338;
  --text: #eeebe4;
  --text-muted: #808088;
  --text-dim: #464650;
  --accent: #e9a93c;
  --accent-soft: rgba(233,169,60,0.1);
  --accent-mid: rgba(233,169,60,0.2);
  --danger: #e85555;
  --danger-soft: rgba(232,85,85,0.1);
  --success: #4caf7d;
  --success-soft: rgba(76,175,125,0.1);
  --r: 14px;
  --r-sm: 10px;
  --r-xs: 7px;
  --mono: 'DM Mono', monospace;
  --sans: 'Syne', sans-serif;
  --safe-b: env(safe-area-inset-bottom, 0px);
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100dvh;-webkit-font-smoothing:antialiased;overflow-x:hidden}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
#root{display:flex;flex-direction:column;min-height:100dvh;max-width:480px;margin:0 auto}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.header{
  padding:16px 18px 0;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:20;
  background:var(--bg);
}
.logo{font-size:13px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent)}
.hdr-right{display:flex;gap:8px;align-items:center}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tabs{display:flex;gap:3px;padding:14px 18px 0;overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{
  padding:7px 15px;border-radius:20px;border:1px solid var(--border);
  background:none;color:var(--text-muted);font-family:var(--sans);
  font-size:13px;font-weight:500;cursor:pointer;white-space:nowrap;
  flex-shrink:0;transition:all .15s;
}
.tab.on{background:var(--accent);border-color:var(--accent);color:#0c0c0d}
.tab:not(.on):active{background:var(--surface2)}

/* â”€â”€â”€ SCROLL AREA â”€â”€â”€ */
.main{flex:1;overflow-y:auto;padding:18px 18px 0;padding-bottom:calc(140px + var(--safe-b))}
.main::-webkit-scrollbar{width:0}

/* â”€â”€â”€ CARDS â”€â”€â”€ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px}
.card+.card,.card+.shoe-card,.shoe-card+.card,.shoe-card+.shoe-card{margin-top:10px}

/* â”€â”€â”€ SECTION HDR â”€â”€â”€ */
.sec{display:flex;align-items:center;justify-content:space-between;margin:20px 0 12px}
.sec-title{font-size:11px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted)}
.sec-btn{font-size:13px;color:var(--accent);cursor:pointer;background:none;border:none;font-family:var(--sans);font-weight:600;padding:4px 0}

/* â”€â”€â”€ STAT CARDS â”€â”€â”€ */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-sm);padding:14px}
.stat-val{font-family:var(--mono);font-size:20px;font-weight:400;color:var(--text);line-height:1}
.stat-lbl{font-size:11px;color:var(--text-muted);margin-top:5px;font-weight:500;letter-spacing:.06em;text-transform:uppercase}

/* hero stat */
.hero-card{
  background:linear-gradient(135deg,var(--surface) 0%,var(--surface2) 100%);
  border:1px solid var(--border);border-radius:var(--r);padding:20px;
  margin-bottom:10px;position:relative;overflow:hidden;
}
.hero-card::after{
  content:'';position:absolute;right:-30px;top:-30px;
  width:120px;height:120px;border-radius:50%;
  background:radial-gradient(circle,var(--accent-mid) 0%,transparent 70%);
  pointer-events:none;
}
.hero-label{font-size:11px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px}
.hero-val{font-family:var(--mono);font-size:44px;font-weight:300;color:var(--text);line-height:1}
.hero-val span{font-size:16px;color:var(--text-muted);margin-left:4px}
.hero-sub{font-size:12px;color:var(--text-dim);margin-top:8px;font-family:var(--mono)}

/* â”€â”€â”€ FILTER PILLS â”€â”€â”€ */
.pills{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;scrollbar-width:none}
.pills::-webkit-scrollbar{display:none}
.pill{
  padding:5px 13px;border-radius:20px;border:1px solid var(--border);
  background:none;color:var(--text-muted);font-size:12px;font-family:var(--sans);
  font-weight:500;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .15s;
}
.pill.on{background:var(--surface2);border-color:var(--border2);color:var(--text)}

/* â”€â”€â”€ SHOE CARDS â”€â”€â”€ */
.shoe-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:16px;position:relative;overflow:hidden;transition:border-color .15s;
}
.shoe-card.is-default{border-color:rgba(233,169,60,.3)}
.shoe-card::before{
  content:'';position:absolute;left:0;top:0;bottom:0;width:3px;
  background:var(--accent);opacity:0;transition:opacity .2s;
}
.shoe-card.is-default::before{opacity:1}

.shoe-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.shoe-name-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.shoe-name{font-size:15px;font-weight:600;color:var(--text)}
.badge{
  font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;
  background:var(--accent-soft);color:var(--accent);border-radius:4px;padding:2px 7px;
}
.shoe-km{font-family:var(--mono);font-size:22px;font-weight:300;color:var(--text);text-align:right;white-space:nowrap}
.shoe-km small{font-size:11px;color:var(--text-muted)}

.prog-wrap{height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;border-radius:2px;background:var(--accent);transition:width .5s ease}
.prog-fill.red{background:var(--danger)}

.shoe-foot{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.shoe-meta{font-size:11px;color:var(--text-dim);font-family:var(--mono)}
.shoe-warn{font-size:11px;color:var(--danger);font-weight:600}

.shoe-actions{display:flex;gap:6px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.shoe-btn{
  flex:1;height:34px;border-radius:var(--r-xs);border:1px solid var(--border);
  background:none;color:var(--text-muted);font-family:var(--sans);font-size:12px;
  font-weight:500;cursor:pointer;transition:all .15s;
}
.shoe-btn:active{background:var(--surface2)}
.shoe-btn.primary{background:var(--accent-soft);border-color:transparent;color:var(--accent)}
.shoe-btn.primary:active{background:var(--accent-mid)}

/* â”€â”€â”€ RUN LIST â”€â”€â”€ */
.run-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:11px 0;border-bottom:1px solid var(--border);
}
.run-item:last-child{border-bottom:none}
.run-left{}
.run-date{font-size:13px;font-family:var(--mono);color:var(--text-muted)}
.run-shoe{font-size:12px;color:var(--text-dim);margin-top:2px}
.run-right{display:flex;align-items:center;gap:4px}
.run-dist{font-family:var(--mono);font-size:16px;font-weight:400;color:var(--text)}
.run-dist small{font-size:11px;color:var(--text-muted)}
.run-act{
  width:28px;height:28px;border-radius:6px;border:none;background:none;
  color:var(--text-dim);cursor:pointer;font-size:13px;transition:all .15s;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.run-act:active{background:var(--surface3)}
.run-act.del:active{background:var(--danger-soft);color:var(--danger)}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
.empty{text-align:center;padding:48px 20px;color:var(--text-dim)}
.empty-icon{font-size:36px;margin-bottom:12px;opacity:.4}
.empty-text{font-size:14px;line-height:1.7;color:var(--text-muted)}

/* â”€â”€â”€ DETAIL â”€â”€â”€ */
.back-btn{
  display:flex;align-items:center;gap:6px;color:var(--accent);
  font-size:13px;font-weight:600;cursor:pointer;background:none;border:none;
  font-family:var(--sans);padding:0;margin-bottom:18px;
}
.detail-name{font-size:22px;font-weight:700;color:var(--text);margin-bottom:4px}
.detail-km{font-family:var(--mono);font-size:48px;font-weight:300;line-height:1;margin-bottom:4px}
.detail-km small{font-size:16px;color:var(--text-muted)}

/* â”€â”€â”€ LOG BAR â”€â”€â”€ */
.log-bar{
  position:fixed;bottom:0;left:0;right:0;
  background:rgba(12,12,13,.93);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:12px 16px;padding-bottom:calc(12px + var(--safe-b));
  z-index:100;
}
.log-inner{display:flex;gap:8px;align-items:center;max-width:480px;margin:0 auto}

.dist-wrap{position:relative;flex:1.2}
.dist-input{
  width:100%;height:50px;background:var(--surface);border:1px solid var(--border);
  border-radius:12px;color:var(--text);font-family:var(--mono);font-size:22px;
  font-weight:300;text-align:center;outline:none;transition:border-color .15s;
  -webkit-appearance:none;padding:0 40px 0 10px;
}
.dist-input:focus{border-color:var(--accent)}
.dist-input::placeholder{color:var(--text-dim);font-size:14px;font-weight:300}
.dist-unit{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:11px;font-family:var(--mono);color:var(--text-dim);pointer-events:none}

.shoe-select{
  height:50px;background:var(--surface);border:1px solid var(--border);
  border-radius:12px;color:var(--text);font-family:var(--sans);font-size:13px;
  font-weight:500;padding:0 28px 0 12px;outline:none;min-width:110px;max-width:140px;
  cursor:pointer;-webkit-appearance:none;appearance:none;flex-shrink:0;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23808088' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;
  transition:border-color .15s;
}
.shoe-select:focus{border-color:var(--accent)}
.shoe-select option{background:#1e1e21}

.save-btn{
  width:50px;height:50px;border-radius:12px;background:var(--accent);border:none;
  color:#0c0c0d;font-size:22px;cursor:pointer;display:flex;align-items:center;
  justify-content:center;flex-shrink:0;transition:all .15s;font-weight:700;
}
.save-btn:active{transform:scale(.9);opacity:.85}

/* â”€â”€â”€ ICON BUTTON â”€â”€â”€ */
.icon-btn{
  width:34px;height:34px;border-radius:50%;border:1px solid var(--border);
  background:var(--surface);color:var(--text-muted);display:flex;align-items:center;
  justify-content:center;cursor:pointer;transition:all .15s;font-size:14px;flex-shrink:0;
}
.icon-btn:active{transform:scale(.9);background:var(--surface2)}

/* â”€â”€â”€ OVERLAY / SHEET â”€â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;
  display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .2s;
}
.overlay.on{opacity:1;pointer-events:all}
.sheet{
  background:var(--surface);border-radius:20px 20px 0 0;border:1px solid var(--border);
  border-bottom:none;padding:22px 20px;padding-bottom:calc(24px + var(--safe-b));
  width:100%;transform:translateY(100%);transition:transform .25s cubic-bezier(.4,0,.2,1);
  max-width:480px;margin:0 auto;
}
.overlay.on .sheet{transform:translateY(0)}
.handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 20px}
.sheet-title{font-size:16px;font-weight:700;margin-bottom:18px;color:var(--text)}

/* â”€â”€â”€ FORM â”€â”€â”€ */
.fg{margin-bottom:14px}
.flabel{font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:7px;display:block}
.finput{
  width:100%;height:46px;background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--r-sm);color:var(--text);font-family:var(--sans);font-size:15px;
  padding:0 13px;outline:none;transition:border-color .15s;-webkit-appearance:none;
}
.finput:focus{border-color:var(--accent)}
.finput-select{
  width:100%;height:46px;background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--r-sm);color:var(--text);font-family:var(--sans);font-size:15px;
  padding:0 36px 0 13px;outline:none;-webkit-appearance:none;appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23808088' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 13px center;
  transition:border-color .15s;
}
.finput-select:focus{border-color:var(--accent)}
.finput-select option{background:#1e1e21}

.btn-row{display:flex;gap:10px;margin-top:6px}
.btn-p{
  flex:1;height:48px;background:var(--accent);border:none;border-radius:var(--r-sm);
  color:#0c0c0d;font-family:var(--sans);font-size:15px;font-weight:700;cursor:pointer;transition:all .15s;
}
.btn-p:active{opacity:.8;transform:scale(.98)}
.btn-g{
  height:48px;padding:0 18px;background:none;border:1px solid var(--border);
  border-radius:var(--r-sm);color:var(--text-muted);font-family:var(--sans);
  font-size:14px;font-weight:500;cursor:pointer;transition:all .15s;
}
.btn-g:active{background:var(--surface2)}
.btn-d{
  width:100%;height:44px;background:var(--danger-soft);border:none;
  border-radius:var(--r-sm);color:var(--danger);font-family:var(--sans);
  font-size:14px;font-weight:600;cursor:pointer;margin-top:8px;transition:all .15s;
}
.btn-d:active{opacity:.75}
.btn-warn{
  width:100%;height:44px;background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--r-sm);color:var(--text-muted);font-family:var(--sans);
  font-size:14px;font-weight:500;cursor:pointer;margin-top:8px;transition:all .15s;
}
.btn-warn:disabled{opacity:.4;cursor:default}

/* â”€â”€â”€ CONFIRM â”€â”€â”€ */
.confirm-body{font-size:14px;color:var(--text-muted);line-height:1.7;margin-bottom:4px}
.confirm-btns{display:flex;gap:10px;margin-top:18px}
.confirm-btns .btn-g{flex:1}
.confirm-btns .btn-d{flex:1;margin-top:0;height:48px}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast{
  position:fixed;top:14px;left:50%;
  transform:translateX(-50%) translateY(-20px);
  background:var(--surface2);border:1px solid var(--border2);
  border-radius:20px;padding:9px 18px;font-size:13px;font-weight:500;
  color:var(--text);z-index:300;opacity:0;
  transition:all .25s cubic-bezier(.4,0,.2,1);pointer-events:none;white-space:nowrap;
}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€â”€ INPUT NUMBER CLEANUP â”€â”€â”€ */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}
input[type=number]{-moz-appearance:textfield}

@media(max-width:360px){
  .shoe-select{min-width:95px;max-width:110px;font-size:12px}
  .hero-val{font-size:36px}
}
</style>
</head>
<body>
<div id="root"></div>
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KEY = 'smt_v12';

function load() {
  try {
    const raw = localStorage.getItem(KEY);
    if (raw) return JSON.parse(raw);
  } catch {}
  return { shoes: [], runs: [] };
}

function save(db) {
  localStorage.setItem(KEY, JSON.stringify(db));
}

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
}

// Migrate old format if present
function migrate() {
  const db = load();
  if (db.shoes.length === 0) {
    // Check old keys
    try {
      const oldShoes = JSON.parse(localStorage.getItem('smt_shoes') || '[]');
      const oldRuns = JSON.parse(localStorage.getItem('smt_runs') || '[]');
      if (oldShoes.length > 0) {
        db.shoes = oldShoes.map(s => ({
          id: s.id, name: s.name,
          purchaseDate: s.purchaseDate || '',
          targetKM: s.targetKM || 500,
          createdAt: s.createdAt, isDefault: s.isDefault
        }));
        db.runs = oldRuns;
        save(db);
        localStorage.removeItem('smt_shoes');
        localStorage.removeItem('smt_runs');
        return db;
      }
    } catch {}
    // Fresh start
    const defaultShoe = {
      id: uid(), name: 'Adizero Evo SL',
      purchaseDate: '', targetKM: 500,
      createdAt: new Date().toISOString(), isDefault: true
    };
    db.shoes = [defaultShoe];
    save(db);
  }
  return db;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n) {
  if (n === undefined || n === null || isNaN(n)) return '0';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
  return n % 1 === 0 ? String(n) : n.toFixed(1);
}

function fmtDate(str) {
  if (!str) return 'â€”';
  const d = new Date(str);
  const today = new Date();
  const yest = new Date(); yest.setDate(today.getDate() - 1);
  if (d.toDateString() === today.toDateString()) return 'Today';
  if (d.toDateString() === yest.toDateString()) return 'Yesterday';
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: d.getFullYear() !== today.getFullYear() ? 'numeric' : undefined });
}

function today() { return new Date().toISOString().slice(0, 10); }

function filterPeriod(runs, period) {
  if (period === 'all') return runs;
  const now = new Date();
  let since = new Date(now);
  if (period === 'week') since.setDate(now.getDate() - 7);
  else if (period === 'month') since.setMonth(now.getMonth() - 1);
  else if (period === 'year') since.setFullYear(now.getFullYear() - 1);
  return runs.filter(r => new Date(r.date) >= since);
}

function shoeRuns(db, shoeId) {
  return db.runs.filter(r => r.shoeId === shoeId);
}

function shoeKm(db, shoeId) {
  return shoeRuns(db, shoeId).reduce((s, r) => s + r.distance, 0);
}

function lastRun(db, shoeId) {
  const rs = shoeRuns(db, shoeId).sort((a, b) => new Date(b.date) - new Date(a.date));
  return rs[0] || null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = migrate();

let st = {
  tab: 'dashboard',
  period: 'all',
  detail: null,       // shoeId for detail view
  modal: null,        // null | addShoe | editShoe | deleteShoe | addRun | editRun | deleteRun
  mdata: {},
  logDist: '',
  logShoe: null,
  logDate: today(),
};

// set default log shoe
if (!st.logShoe && db.shoes.length > 0) {
  st.logShoe = (db.shoes.find(s => s.isDefault) || db.shoes[0]).id;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('on');
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('on'), 2400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const root = document.getElementById('root');
  root.innerHTML = '';
  root.appendChild(buildHeader());
  root.appendChild(buildBody());
  root.appendChild(buildLogBar());
  buildModal();
}

// â”€â”€â”€ HEADER â”€â”€â”€
function buildHeader() {
  const el = ce('div', 'header');
  const logo = ce('div', 'logo'); logo.textContent = 'Shoe Mileage';
  const right = ce('div', 'hdr-right');

  if (st.detail) {
    // nothing extra in header when in detail
  } else {
    const addShoeBtn = mkIconBtn('+', () => openModal('addShoe'));
    addShoeBtn.title = 'Add Shoe';
    right.appendChild(addShoeBtn);
  }

  el.appendChild(logo);
  el.appendChild(right);
  return el;
}

// â”€â”€â”€ BODY â”€â”€â”€
function buildBody() {
  const wrap = ce('div');
  wrap.style.flex = '1';

  if (st.detail) {
    const main = ce('div', 'main');
    main.appendChild(buildDetail());
    wrap.appendChild(main);
    return wrap;
  }

  // Tabs
  const tabs = ce('div', 'tabs');
  [['dashboard','Dashboard'],['shoes','Shoes'],['runs','All Runs']].forEach(([id, label]) => {
    const t = ce('button', 'tab' + (st.tab === id ? ' on' : ''));
    t.textContent = label;
    t.onclick = () => { st.tab = id; render(); };
    tabs.appendChild(t);
  });
  wrap.appendChild(tabs);

  const main = ce('div', 'main');
  if (st.tab === 'dashboard') main.appendChild(buildDashboard());
  else if (st.tab === 'shoes') main.appendChild(buildShoes());
  else main.appendChild(buildAllRuns());
  wrap.appendChild(main);
  return wrap;
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€
function buildDashboard() {
  const f = frag();

  // Period pills
  const pills = ce('div', 'pills');
  pills.style.marginTop = '16px';
  [['all','All Time'],['week','Week'],['month','Month'],['year','Year']].forEach(([id, lbl]) => {
    const p = ce('button', 'pill' + (st.period === id ? ' on' : ''));
    p.textContent = lbl;
    p.onclick = () => { st.period = id; render(); };
    pills.appendChild(p);
  });
  f.appendChild(pills);

  const filtered = filterPeriod(db.runs, st.period);
  const total = filtered.reduce((s, r) => s + r.distance, 0);
  const count = filtered.length;
  const avg = count > 0 ? total / count : 0;
  const longest = count > 0 ? Math.max(...filtered.map(r => r.distance)) : 0;
  const lastR = [...db.runs].sort((a, b) => new Date(b.date) - new Date(a.date))[0];

  // Hero
  const hero = ce('div', 'hero-card');
  hero.innerHTML = `
    <div class="hero-label">Total Distance</div>
    <div class="hero-val">${fmt(total)}<span>km</span></div>
    <div class="hero-sub">${lastR ? `Last run ${fmtDate(lastR.date)} Â· ${lastR.distance} km` : 'No runs yet'}</div>
  `;
  f.appendChild(hero);

  // Stats grid
  const grid = ce('div', 'stat-grid');
  [[fmt(count), 'Runs'],[`${fmt(avg)} km`, 'Avg'],[`${fmt(longest)} km`, 'Longest'],[`${db.shoes.length}`, 'Shoes']].forEach(([v, l]) => {
    const c = ce('div', 'stat-card');
    c.innerHTML = `<div class="stat-val">${v}</div><div class="stat-lbl">${l}</div>`;
    grid.appendChild(c);
  });
  f.appendChild(grid);

  // Shoe breakdown
  if (db.shoes.length > 0) {
    const sh = ce('div', 'sec');
    sh.innerHTML = '<span class="sec-title">Per Shoe</span>';
    f.appendChild(sh);

    db.shoes.forEach(shoe => {
      const km = shoeKm(db, shoe.id);
      const fkm = filterPeriod(db.runs, st.period).filter(r => r.shoeId === shoe.id).reduce((s,r)=>s+r.distance,0);
      const tgt = shoe.targetKM || 500;
      const pct = Math.min((km / tgt) * 100, 100);
      const warn = km >= tgt;

      const c = ce('div', 'card');
      c.style.cursor = 'pointer';
      c.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-size:14px;font-weight:600;color:var(--text)">${shoe.name}</div>
          <div class="shoe-km">${fmt(fkm)}<small> km</small></div>
        </div>
        <div class="prog-wrap"><div class="prog-fill ${warn?'red':''}" style="width:${pct}%"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:7px">
          <div style="font-size:11px;color:var(--text-dim);font-family:var(--mono)">${fmt(km)} / ${tgt} km total</div>
          ${warn ? '<div class="shoe-warn">âš  Replace soon</div>' : `<div style="font-size:11px;color:var(--text-dim);font-family:var(--mono)">${fmt(tgt-km)} km left</div>`}
        </div>
      `;
      c.onclick = () => { st.detail = shoe.id; render(); };
      f.appendChild(c);
    });
  }

  return f;
}

// â”€â”€â”€ SHOES â”€â”€â”€
function buildShoes() {
  const f = frag();
  const sh = ce('div', 'sec');
  sh.style.marginTop = '16px';
  const t = ce('span', 'sec-title'); t.textContent = 'Your Shoes';
  const btn = ce('button', 'sec-btn'); btn.textContent = '+ Add Shoe';
  btn.onclick = () => openModal('addShoe');
  sh.appendChild(t); sh.appendChild(btn);
  f.appendChild(sh);

  if (db.shoes.length === 0) {
    f.appendChild(emptyState('ğŸ‘Ÿ', 'No shoes yet.', 'Add your first shoe to start tracking.'));
    return f;
  }

  db.shoes.forEach(shoe => {
    const km = shoeKm(db, shoe.id);
    const tgt = shoe.targetKM || 500;
    const pct = Math.min((km / tgt) * 100, 100);
    const warn = km >= tgt;
    const sr = shoeRuns(db, shoe.id);
    const lr = lastRun(db, shoe.id);

    const card = ce('div', 'shoe-card' + (shoe.isDefault ? ' is-default' : ''));

    card.innerHTML = `
      <div class="shoe-top">
        <div>
          <div class="shoe-name-row">
            <div class="shoe-name">${shoe.name}</div>
            ${shoe.isDefault ? '<div class="badge">Default</div>' : ''}
          </div>
          <div style="font-size:11px;color:var(--text-dim);margin-top:3px;font-family:var(--mono)">
            ${sr.length} run${sr.length !== 1 ? 's' : ''} Â· Last: ${lr ? fmtDate(lr.date) : 'Never'}
          </div>
        </div>
        <div>
          <div class="shoe-km">${fmt(km)}<small> km</small></div>
          <div style="font-size:10px;color:var(--text-dim);text-align:right;margin-top:3px;font-family:var(--mono)">${pct.toFixed(0)}%</div>
        </div>
      </div>
      <div class="prog-wrap"><div class="prog-fill ${warn?'red':''}" style="width:${pct}%"></div></div>
      <div class="shoe-foot">
        <div class="shoe-meta">${fmt(tgt - km > 0 ? tgt - km : 0)} km remaining of ${tgt}</div>
        ${warn ? '<div class="shoe-warn">âš  Replace soon</div>' : ''}
      </div>
      <div class="shoe-actions">
        <button class="shoe-btn primary" data-action="log">+ Log Run</button>
        <button class="shoe-btn" data-action="view">View Runs</button>
        <button class="shoe-btn" data-action="edit">Edit</button>
        <button class="shoe-btn" data-action="del" style="color:var(--danger)">Delete</button>
      </div>
    `;

    card.querySelector('[data-action="log"]').onclick = (e) => {
      e.stopPropagation();
      st.logShoe = shoe.id;
      // focus log bar
      render();
      setTimeout(() => document.getElementById('logDistInput')?.focus(), 100);
    };
    card.querySelector('[data-action="view"]').onclick = (e) => {
      e.stopPropagation();
      st.detail = shoe.id;
      render();
    };
    card.querySelector('[data-action="edit"]').onclick = (e) => {
      e.stopPropagation();
      openModal('editShoe', { shoe });
    };
    card.querySelector('[data-action="del"]').onclick = (e) => {
      e.stopPropagation();
      openModal('deleteShoe', { shoe });
    };

    f.appendChild(card);
  });

  return f;
}

// â”€â”€â”€ ALL RUNS â”€â”€â”€
function buildAllRuns() {
  const f = frag();
  const sh = ce('div', 'sec');
  sh.style.marginTop = '16px';
  sh.innerHTML = '<span class="sec-title">All Runs</span>';
  f.appendChild(sh);

  const sorted = [...db.runs].sort((a, b) => new Date(b.date) - new Date(a.date));

  if (sorted.length === 0) {
    f.appendChild(emptyState('ğŸƒ', 'No runs logged yet.', 'Enter a distance below and tap + to save.'));
    return f;
  }

  const card = ce('div', 'card');
  card.style.padding = '4px 16px';
  sorted.forEach(run => {
    card.appendChild(buildRunItem(run, true));
  });
  f.appendChild(card);
  return f;
}

function buildRunItem(run, showShoe) {
  const shoe = db.shoes.find(s => s.id === run.shoeId);
  const item = ce('div', 'run-item');
  const left = ce('div', 'run-left');
  left.innerHTML = `
    <div class="run-date">${fmtDate(run.date)}</div>
    ${showShoe ? `<div class="run-shoe">${shoe ? shoe.name : 'Unknown'}</div>` : ''}
  `;
  const right = ce('div', 'run-right');
  right.innerHTML = `<div class="run-dist">${run.distance}<small> km</small></div>`;

  const editBtn = ce('button', 'run-act');
  editBtn.innerHTML = 'âœ';
  editBtn.title = 'Edit';
  editBtn.onclick = () => openModal('editRun', { run });

  const delBtn = ce('button', 'run-act del');
  delBtn.innerHTML = 'âœ•';
  delBtn.title = 'Delete';
  delBtn.onclick = () => openModal('deleteRun', { run });

  right.appendChild(editBtn);
  right.appendChild(delBtn);
  item.appendChild(left);
  item.appendChild(right);
  return item;
}

// â”€â”€â”€ SHOE DETAIL â”€â”€â”€
function buildDetail() {
  const shoe = db.shoes.find(s => s.id === st.detail);
  if (!shoe) { st.detail = null; return buildDashboard(); }

  const sr = shoeRuns(db, shoe.id).sort((a, b) => new Date(b.date) - new Date(a.date));
  const km = shoeKm(db, shoe.id);
  const tgt = shoe.targetKM || 500;
  const pct = Math.min((km / tgt) * 100, 100);
  const warn = km >= tgt;

  const f = frag();

  const back = ce('button', 'back-btn');
  back.innerHTML = 'â† Back';
  back.onclick = () => { st.detail = null; render(); };
  f.appendChild(back);

  // Name row
  const nameRow = ce('div');
  nameRow.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px';
  const nameLeft = ce('div');
  nameLeft.innerHTML = `
    <div class="detail-name">${shoe.name}</div>
    ${shoe.isDefault ? '<div class="badge" style="display:inline-block;margin-top:4px">Default</div>' : ''}
  `;
  const editBtn = mkIconBtn('âœ', () => openModal('editShoe', { shoe }));
  nameRow.appendChild(nameLeft);
  nameRow.appendChild(editBtn);
  f.appendChild(nameRow);

  // KM
  const kmEl = ce('div', 'detail-km');
  kmEl.innerHTML = `${fmt(km)}<small> km</small>`;
  f.appendChild(kmEl);

  // Progress
  const prog = ce('div');
  prog.style.marginBottom = '18px';
  prog.innerHTML = `
    <div class="prog-wrap" style="height:5px;margin:6px 0">
      <div class="prog-fill ${warn?'red':''}" style="width:${pct}%"></div>
    </div>
    <div style="display:flex;justify-content:space-between">
      <div style="font-size:12px;color:var(--text-muted);font-family:var(--mono)">${pct.toFixed(0)}% of ${tgt} km</div>
      ${warn ? '<div class="shoe-warn">âš  Time to replace</div>' : `<div style="font-size:12px;color:var(--text-dim);font-family:var(--mono)">${fmt(tgt-km)} km remaining</div>`}
    </div>
  `;
  f.appendChild(prog);

  // Mini stats
  const grid = ce('div', 'stat-grid');
  const lr = sr[0];
  [[String(sr.length), 'Runs'],[lr ? fmtDate(lr.date) : 'â€”', 'Last Run']].forEach(([v, l]) => {
    const c = ce('div', 'stat-card');
    c.innerHTML = `<div class="stat-val" style="font-size:16px">${v}</div><div class="stat-lbl">${l}</div>`;
    grid.appendChild(c);
  });
  f.appendChild(grid);

  // Log run btn
  const logBtn = ce('button', 'btn-p');
  logBtn.style.cssText = 'width:100%;margin-bottom:20px;margin-top:4px';
  logBtn.textContent = '+ Log Run';
  logBtn.onclick = () => {
    st.logShoe = shoe.id;
    render();
    setTimeout(() => document.getElementById('logDistInput')?.focus(), 100);
  };
  f.appendChild(logBtn);

  // Runs list
  const secEl = ce('div', 'sec');
  secEl.innerHTML = '<span class="sec-title">Runs</span>';
  f.appendChild(secEl);

  if (sr.length === 0) {
    f.appendChild(emptyState('', 'No runs yet.', ''));
  } else {
    const card = ce('div', 'card');
    card.style.padding = '4px 16px';
    sr.forEach(run => card.appendChild(buildRunItem(run, false)));
    f.appendChild(card);
  }

  return f;
}

// â”€â”€â”€ LOG BAR â”€â”€â”€
function buildLogBar() {
  if (!st.logShoe && db.shoes.length > 0) {
    st.logShoe = (db.shoes.find(s => s.isDefault) || db.shoes[0]).id;
  }

  const bar = ce('div', 'log-bar');
  const inner = ce('div', 'log-inner');

  const distWrap = ce('div', 'dist-wrap');
  const distInput = ce('input');
  distInput.type = 'number';
  distInput.inputMode = 'decimal';
  distInput.id = 'logDistInput';
  distInput.className = 'dist-input';
  distInput.placeholder = '0.0';
  distInput.value = st.logDist;
  distInput.step = '0.1';
  distInput.min = '0';
  distInput.max = '500';
  distInput.setAttribute('autocomplete', 'off');
  distInput.oninput = e => { st.logDist = e.target.value; };
  distInput.addEventListener('focus', function() { setTimeout(() => this.select(), 50); });
  distInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSaveRun(); });

  const unit = ce('span', 'dist-unit');
  unit.textContent = 'km';
  distWrap.appendChild(distInput);
  distWrap.appendChild(unit);

  const sel = ce('select', 'shoe-select');
  sel.id = 'logShoeSelect';
  db.shoes.forEach(s => {
    const o = document.createElement('option');
    o.value = s.id;
    o.textContent = s.name;
    o.selected = s.id === st.logShoe;
    sel.appendChild(o);
  });
  sel.onchange = e => { st.logShoe = e.target.value; };

  const saveBtn = ce('button', 'save-btn');
  saveBtn.textContent = '+';
  saveBtn.onclick = doSaveRun;

  inner.appendChild(distWrap);
  inner.appendChild(sel);
  inner.appendChild(saveBtn);
  bar.appendChild(inner);
  return bar;
}

function doSaveRun() {
  const dist = parseFloat(st.logDist);
  if (!dist || dist <= 0 || isNaN(dist)) {
    toast('âš   Enter a valid distance');
    document.getElementById('logDistInput')?.focus();
    return;
  }
  if (!st.logShoe) {
    toast('âš   Select a shoe');
    return;
  }
  const run = {
    id: uid(), shoeId: st.logShoe,
    distance: Math.round(dist * 10) / 10,
    date: st.logDate || today(),
    createdAt: new Date().toISOString()
  };
  db.runs.push(run);
  save(db);
  st.logDist = '';
  st.logDate = today();

  const shoe = db.shoes.find(s => s.id === run.shoeId);
  toast(`âœ“  ${run.distance} km saved to ${shoe?.name || 'shoe'}`);

  const total = shoeKm(db, run.shoeId);
  const tgt = shoe?.targetKM || 500;
  if (total >= tgt) {
    setTimeout(() => toast(`âš   ${shoe?.name} has ${fmt(total)} km â€” time to replace!`), 2600);
  }
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(type, data = {}) {
  st.modal = type; st.mdata = data; render();
}
function closeModal() {
  st.modal = null; st.mdata = {}; render();
}

function buildModal() {
  const existing = document.getElementById('modal-overlay');
  if (existing) existing.remove();
  if (!st.modal) return;

  const overlay = ce('div', 'overlay');
  overlay.id = 'modal-overlay';
  overlay.onclick = e => { if (e.target === overlay) closeModal(); };

  const sheet = ce('div', 'sheet');
  const handle = ce('div', 'handle');
  sheet.appendChild(handle);

  // â”€â”€ Add Shoe â”€â”€
  if (st.modal === 'addShoe') {
    sheet.appendChild(mkTitle('Add Shoe'));

    const fields = `
      <div class="fg"><label class="flabel">Shoe Name</label><input class="finput" id="m_name" type="text" placeholder="e.g. Pegasus 41" autocomplete="off" /></div>
      <div class="fg"><label class="flabel">Purchase Date (optional)</label><input class="finput" id="m_date" type="date" /></div>
      <div class="fg"><label class="flabel">Target KM (default 500)</label><input class="finput" id="m_tgt" type="number" inputmode="numeric" placeholder="500" min="1" max="5000" /></div>
    `;
    const fieldsEl = ce('div');
    fieldsEl.innerHTML = fields;
    sheet.appendChild(fieldsEl);

    const row = ce('div', 'btn-row');
    const cancel = mkBtnG('Cancel', closeModal);
    const save = mkBtnP('Add Shoe', () => {
      const name = document.getElementById('m_name').value.trim();
      if (!name) { toast('âš   Enter a shoe name'); return; }
      const tgt = parseInt(document.getElementById('m_tgt').value) || 500;
      const pd = document.getElementById('m_date').value;
      const shoe = { id: uid(), name, purchaseDate: pd, targetKM: tgt, createdAt: new Date().toISOString(), isDefault: db.shoes.length === 0 };
      db.shoes.push(shoe);
      save(db);
      if (!st.logShoe) st.logShoe = shoe.id;
      toast(`ğŸ‘Ÿ  ${name} added`);
      closeModal();
    });
    row.appendChild(cancel); row.appendChild(save);
    sheet.appendChild(row);

  // â”€â”€ Edit Shoe â”€â”€
  } else if (st.modal === 'editShoe') {
    const { shoe } = st.mdata;
    sheet.appendChild(mkTitle('Edit Shoe'));

    const fieldsEl = ce('div');
    fieldsEl.innerHTML = `
      <div class="fg"><label class="flabel">Shoe Name</label><input class="finput" id="m_name" type="text" value="${shoe.name}" autocomplete="off" /></div>
      <div class="fg"><label class="flabel">Purchase Date</label><input class="finput" id="m_date" type="date" value="${shoe.purchaseDate || ''}" /></div>
      <div class="fg"><label class="flabel">Target KM</label><input class="finput" id="m_tgt" type="number" inputmode="numeric" value="${shoe.targetKM || 500}" min="1" max="5000" /></div>
    `;
    sheet.appendChild(fieldsEl);

    const row = ce('div', 'btn-row');
    const cancel = mkBtnG('Cancel', closeModal);
    const saveb = mkBtnP('Save', () => {
      const name = document.getElementById('m_name').value.trim();
      if (!name) { toast('âš   Enter a name'); return; }
      shoe.name = name;
      shoe.purchaseDate = document.getElementById('m_date').value;
      shoe.targetKM = parseInt(document.getElementById('m_tgt').value) || 500;
      save(db);
      toast('âœ“  Shoe updated');
      closeModal();
    });
    row.appendChild(cancel); row.appendChild(saveb);
    sheet.appendChild(row);

    const setDefBtn = ce('button', 'btn-warn');
    setDefBtn.textContent = shoe.isDefault ? 'âœ“ Default shoe' : 'Set as default';
    setDefBtn.disabled = shoe.isDefault;
    setDefBtn.onclick = () => {
      db.shoes.forEach(s => s.isDefault = false);
      shoe.isDefault = true;
      st.logShoe = shoe.id;
      save(db);
      toast(`âœ“  ${shoe.name} is now default`);
      closeModal();
    };
    sheet.appendChild(setDefBtn);

    const delBtn = ce('button', 'btn-d');
    delBtn.textContent = 'Delete Shoe';
    delBtn.onclick = () => openModal('deleteShoe', { shoe });
    sheet.appendChild(delBtn);

  // â”€â”€ Delete Shoe â”€â”€
  } else if (st.modal === 'deleteShoe') {
    const { shoe } = st.mdata;
    const rc = shoeRuns(db, shoe.id).length;
    sheet.appendChild(mkTitle('Delete Shoe?'));
    const body = ce('div', 'confirm-body');
    body.innerHTML = `<strong style="color:var(--text)">"${shoe.name}"</strong> and all <strong style="color:var(--text)">${rc} run${rc!==1?'s':''}</strong> logged to it will be permanently deleted.`;
    sheet.appendChild(body);
    const btns = ce('div', 'confirm-btns');
    btns.appendChild(mkBtnG('Cancel', closeModal));
    const del = ce('button', 'btn-d');
    del.style.cssText = 'flex:1;height:48px;margin-top:0;border-radius:var(--r-sm)';
    del.textContent = 'Delete';
    del.onclick = () => {
      db.runs = db.runs.filter(r => r.shoeId !== shoe.id);
      db.shoes = db.shoes.filter(s => s.id !== shoe.id);
      if (db.shoes.length > 0 && !db.shoes.find(s => s.isDefault)) db.shoes[0].isDefault = true;
      if (st.logShoe === shoe.id) st.logShoe = db.shoes[0]?.id || null;
      if (st.detail === shoe.id) st.detail = null;
      save(db);
      toast(`ğŸ—‘  ${shoe.name} deleted`);
      closeModal();
    };
    btns.appendChild(del);
    sheet.appendChild(btns);

  // â”€â”€ Add Run â”€â”€
  } else if (st.modal === 'addRun') {
    const preShoe = st.mdata.shoeId || st.logShoe;
    sheet.appendChild(mkTitle('Log Run'));

    const fieldsEl = ce('div');
    fieldsEl.innerHTML = `
      <div class="fg"><label class="flabel">Distance (km)</label><input class="finput" id="m_dist" type="number" inputmode="decimal" placeholder="0.0" step="0.1" min="0" max="500" /></div>
      <div class="fg"><label class="flabel">Shoe</label>
        <select class="finput-select" id="m_shoe">
          ${db.shoes.map(s => `<option value="${s.id}" ${s.id===preShoe?'selected':''}>${s.name}</option>`).join('')}
        </select>
      </div>
      <div class="fg"><label class="flabel">Date</label><input class="finput" id="m_date" type="date" value="${today()}" /></div>
    `;
    sheet.appendChild(fieldsEl);

    const row = ce('div', 'btn-row');
    const cancel = mkBtnG('Cancel', closeModal);
    const saveb = mkBtnP('Save Run', () => {
      const dist = parseFloat(document.getElementById('m_dist').value);
      if (!dist || dist <= 0) { toast('âš   Enter a valid distance'); return; }
      const run = {
        id: uid(),
        shoeId: document.getElementById('m_shoe').value,
        distance: Math.round(dist * 10) / 10,
        date: document.getElementById('m_date').value || today(),
        createdAt: new Date().toISOString()
      };
      db.runs.push(run);
      save(db);
      toast(`âœ“  ${run.distance} km saved`);
      closeModal();
    });
    row.appendChild(cancel); row.appendChild(saveb);
    sheet.appendChild(row);

  // â”€â”€ Edit Run â”€â”€
  } else if (st.modal === 'editRun') {
    const { run } = st.mdata;
    sheet.appendChild(mkTitle('Edit Run'));

    const fieldsEl = ce('div');
    fieldsEl.innerHTML = `
      <div class="fg"><label class="flabel">Distance (km)</label><input class="finput" id="m_dist" type="number" inputmode="decimal" value="${run.distance}" step="0.1" min="0" max="500" /></div>
      <div class="fg"><label class="flabel">Shoe</label>
        <select class="finput-select" id="m_shoe">
          ${db.shoes.map(s => `<option value="${s.id}" ${s.id===run.shoeId?'selected':''}>${s.name}</option>`).join('')}
        </select>
      </div>
      <div class="fg"><label class="flabel">Date</label><input class="finput" id="m_date" type="date" value="${run.date}" /></div>
    `;
    sheet.appendChild(fieldsEl);

    const row = ce('div', 'btn-row');
    const cancel = mkBtnG('Cancel', closeModal);
    const saveb = mkBtnP('Save', () => {
      const dist = parseFloat(document.getElementById('m_dist').value);
      if (!dist || dist <= 0) { toast('âš   Enter a valid distance'); return; }
      run.distance = Math.round(dist * 10) / 10;
      run.shoeId = document.getElementById('m_shoe').value;
      run.date = document.getElementById('m_date').value || today();
      save(db);
      toast('âœ“  Run updated');
      closeModal();
    });
    row.appendChild(cancel); row.appendChild(saveb);
    sheet.appendChild(row);

    const delBtn = ce('button', 'btn-d');
    delBtn.textContent = 'Delete Run';
    delBtn.onclick = () => openModal('deleteRun', { run });
    sheet.appendChild(delBtn);

  // â”€â”€ Delete Run â”€â”€
  } else if (st.modal === 'deleteRun') {
    const { run } = st.mdata;
    sheet.appendChild(mkTitle('Delete Run?'));
    const body = ce('div', 'confirm-body');
    body.innerHTML = `<strong style="color:var(--text)">${run.distance} km</strong> on ${fmtDate(run.date)} will be removed.`;
    sheet.appendChild(body);
    const btns = ce('div', 'confirm-btns');
    btns.appendChild(mkBtnG('Cancel', closeModal));
    const del = ce('button', 'btn-d');
    del.style.cssText = 'flex:1;height:48px;margin-top:0;border-radius:var(--r-sm)';
    del.textContent = 'Delete';
    del.onclick = () => {
      db.runs = db.runs.filter(r => r.id !== run.id);
      save(db);
      toast('ğŸ—‘  Run deleted');
      closeModal();
    };
    btns.appendChild(del);
    sheet.appendChild(btns);
  }

  overlay.appendChild(sheet);
  document.getElementById('root').appendChild(overlay);

  requestAnimationFrame(() => {
    overlay.classList.add('on');
    const first = sheet.querySelector('input[type="text"],input[type="number"]');
    if (first) setTimeout(() => first.focus(), 260);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ce(tag, cls) {
  const el = document.createElement(tag);
  if (cls) el.className = cls;
  return el;
}
function frag() { return document.createDocumentFragment(); }
function mkIconBtn(icon, onclick) {
  const b = ce('button', 'icon-btn');
  b.innerHTML = icon; b.onclick = onclick;
  return b;
}
function mkTitle(txt) {
  const el = ce('div', 'sheet-title');
  el.textContent = txt;
  return el;
}
function mkBtnP(txt, onclick) {
  const b = ce('button', 'btn-p');
  b.textContent = txt; b.onclick = onclick;
  return b;
}
function mkBtnG(txt, onclick) {
  const b = ce('button', 'btn-g');
  b.textContent = txt; b.onclick = onclick;
  return b;
}
function emptyState(icon, title, sub) {
  const el = ce('div', 'empty');
  el.innerHTML = `${icon ? `<div class="empty-icon">${icon}</div>` : ''}<div class="empty-text"><strong>${title}</strong>${sub ? '<br>'+sub : ''}</div>`;
  return el;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
</script>
</body>
</html>
